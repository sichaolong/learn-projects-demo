### 数据实时同步方案



1、数据库迁移场景：以MySQL数据库迁移为例，数据库常用迁移方案有停机迁移和平滑迁移。 平滑迁移又分为

- 双写：所有的写入操作写入新表和旧表，这种方式可以通过代码控制，但是问题是会引入分布式一致性问题，要保证新旧库中两张数据表一致，双写操作必须在一个数据库中执行，因此会引入分布式事务问题，代价很高。
- CDC（数据变更抓取）：通过数据源的事务日志抓取数据源变更解决数据同步问题。





2、数据同步场景

- 两套环境MySQL，正式环境只提供可读（正式环境部分书籍可直接修改），编辑环境可供修改且修改之后，需要实时的保证正式环境和编辑环境的数据一致。
- 项目中使用Redis、Solr、ES等全文检索服务，需要将MySQL中变化的数据实时同步到全文检索服务。



3、以上面的场景2为例，常见的数据实时同步方案

- 应用代码同步，修改数据库的时候及联修改ES、Redis等服务数据。
  - 优点：实施起来比较简单，适用于简单服务
  - 缺点：代码耦合度高，和业务逻辑同步执行，效率变低。
- 定时任务同步，在数据库中执行完增加、修改、删除操作后，通过定时任务定时的将数据库的数据同步到ES索引库中，相关技术Quartz、XXLJOB。这里执行定时任务的时候，一般会根据数据的一个时间字段做边界查询，避免每次都是扫全量数据，比如首次按照updateTime逆序排序，然后之后每次执需要同步数据查询的时候，只需查询时间 > updateTime的即可。
  - 优点：同步ES索引库的操作和业务代码完全解耦。
  - 缺点：数据的实时性并不高。
- 消息队列MQ同步，数据完成修改更新之后，会发送一个MQ消息，此时同步程序作为MQ中的消费者，从消息队列中获取消息，然后将数据更新到ES索引库。
  -  优点：业务代码逻辑高，并且能做到准实时。
  - 缺点：需要代码中加入MQ发送代码，数据调用接口耦合。
- CDC（Change Data Capture，数据变更抓取），通过CDC来解析数据库的日志信息，检测数据库中表结构和数据的变化，从而更新ES索引库。
  - 优点：与业务解耦，与API解耦，可以做到准实时。
  - 缺点：对于不同的数据源如MySQL、SQL Server没有统一的数据变更抓取协议。比如MySQL使用BinLog、PostgreSQL用Logical decoding机制，MnogoDB使用oplog





### Canal实践与原理分析
// TODO








